const openByTabId = new Map();

chrome?.tabs?.onRemoved?.addListener((tabId) => {
	openByTabId.delete(tabId);
});

// Apply the display mode (popup vs sidePanel)
function applyDisplayMode(mode) {
	if (mode === 'popup') {
		chrome?.action.setPopup({ popup: 'popup.html' });
	} else {
		// sidePanel mode: clear popup so onClicked fires
		chrome?.action.setPopup({ popup: '' });
	}
}

// Initialize display mode on startup
chrome?.storage.local.get({ displayMode: 'sidePanel' }, (result) => {
	applyDisplayMode(result.displayMode);
});

// Listen for changes to displayMode
chrome?.storage.onChanged.addListener((changes, area) => {
	if (area === 'local' && changes.displayMode) {
		applyDisplayMode(changes.displayMode.newValue);
	}
});

chrome?.action.onClicked.addListener((tab) => {
	try {
		if (!chrome?.sidePanel?.open) {
			return;
		}

		const tabId = typeof tab?.id === 'number' ? tab.id : undefined;
		if (tabId == null) {
			return;
		}

		const isOpen = openByTabId.get(tabId) === true;

		if (isOpen) {
			if (typeof chrome?.sidePanel.close === 'function') {
				chrome?.sidePanel.close({ tabId }).catch(() => { /* ignore */ });
			} else if (typeof chrome?.sidePanel.setOptions === 'function') {
				chrome?.sidePanel.setOptions({ tabId, enabled: false }).catch(() => { /* ignore */ });
			}
			openByTabId.set(tabId, false);
			return;
		}

		// Fire-and-forget
		if (typeof chrome?.sidePanel.setOptions === 'function') {
			chrome?.sidePanel
				.setOptions({ tabId, enabled: true, path: 'popup.html' })
				.catch(() => { /* ignore */ });
		}

		chrome?.sidePanel
			.open({ tabId })
			.then(() => openByTabId.set(tabId, true))
			.catch(() => {
				openByTabId.set(tabId, false);
			});
	} catch (error) { /* ignore */ }
});
